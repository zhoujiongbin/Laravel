(function($){$.fn.bsSuggest=function(opts){if(typeof opts==="string"&&methods[opts]){return methods[opts].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof opts==="object"||!opts){return methods.init.apply(this,arguments)}}};var methods={init:function(opts){var self=this,options=$.extend({url:null,jsonp:null,data:{},getDataMethod:"firstByUrl",indexId:0,indexKey:0,idField:"",keyField:"",effectiveFields:[],effectiveFieldsAlias:{userName:"姓名"},searchFields:[],showHeader:false,allowNoKeyword:true,multiWord:false,separator:",",processData:processData,getData:getData,autoMinWidth:false,listAlign:"left",inputWarnColor:"rgba(255,0,0,.1)",listStyle:{"padding-top":0,"max-height":"375px","max-width":"800px","overflow":"auto","width":"100%","transition":"0.5s","-webkit-transition":"0.5s","-moz-transition":"0.5s","-o-transition":"0.5s"},listHoverStyle:"background: #07d; color:#fff",listHoverCSS:"jhover",keyLeft:37,keyUp:38,keyRight:39,keyDown:40,keyEnter:13},opts);if($.isFunction(options.processData)){processData=options.processData}if($.isFunction(options.getData)){getData=options.getData}if(!opts.showHeader&&options.effectiveFields&&options.effectiveFields.length>1){options.showHeader=true}if(options.getDataMethod==="firstByUrl"&&options.url){var hyphen=opts.url.indexOf("?")!==-1?"&":"?",URL=opts.jsonp?[opts.url,hyphen,opts.jsonp,"=?"].join(""):opts.url;$.ajax({type:"GET",url:URL,dataType:"json",timeout:5000}).done(function(result){options.data=result;options.url=null;$(self).trigger("onDataRequestSuccess",result)}).fail(function(o,err){throw new Error(URL+" : "+err)})}$("head:eq(0)").append("<style>."+options.listHoverCSS+"{"+options.listHoverStyle+"}</style>");return self.each(function(){var $input=$(this),$dropdownMenu=$input.parent(".input-group").find("ul.dropdown-menu");if(checkInput(this)===false){return}$input.removeClass("disabled").attr("disabled",false).attr("autocomplete","off");$dropdownMenu.css(options.listStyle||{"max-height":"300px","max-width":"800px","overflow":"auto"});if(options.autoMinWidth===false){$dropdownMenu.css({"min-width":$input.parent().width()})}else{}if(options.listAlign==="left"){$dropdownMenu.css({"left":$input.siblings("div").width()-$input.parent().width(),"right":"auto"})}else{if(options.listAlign==="right"){$dropdownMenu.css({"left":"auto","right":"0"})}}$input.on("keydown",function(event){var currentList,tipsKeyword="";if($dropdownMenu.css("display")!=="none"){currentList=$dropdownMenu.find("."+options.listHoverCSS);tipsKeyword="";if(event.keyCode===options.keyDown){if(currentList.length===0){tipsKeyword=getPointKeyword($dropdownMenu.find("table tbody tr:first").mouseover())}else{if(currentList.next().length===0){unHoverAll($dropdownMenu,options);$(this).val($(this).attr("alt")).attr("data-id","")}else{unHoverAll($dropdownMenu,options);if(currentList.next().length!==0){tipsKeyword=getPointKeyword(currentList.next().mouseover())}}}adjustScroll($input,$dropdownMenu)}else{if(event.keyCode===options.keyUp){if(currentList.length===0){tipsKeyword=getPointKeyword($dropdownMenu.find("table tbody tr:last").mouseover())}else{if(currentList.prev().length===0){unHoverAll($dropdownMenu,options);$(this).val($(this).attr("alt")).attr("data-id","")}else{unHoverAll($dropdownMenu,options);if(currentList.prev().length!==0){tipsKeyword=getPointKeyword(currentList.prev().mouseover())}}}adjustScroll($input,$dropdownMenu)}else{if(event.keyCode===options.keyEnter){$dropdownMenu.hide().empty()}else{$(this).attr("data-id","")}}}if(tipsKeyword&&tipsKeyword.key!==""){setValue($(this),tipsKeyword,options)}}}).on("keyup",function(event){var word,words;if(event.keyCode===options.keyDown||event.keyCode===options.keyUp||event.keyCode===options.keyEnter){$(this).val($(this).val());setBackground($input,options);return}else{$(this).attr("data-id","");setBackground($input,options)}word=$(this).val();if($.trim(word)!==""&&word===$(this).attr("alt")){return}$(this).attr("alt",$(this).val());if(opts.multiWord){words=word.split(options.separator||" ");word=words[words.length-1]}if(word.length===0&&!options.allowNoKeyword){return}getData($.trim(word),$input,refreshDropMenu,options)}).on("focus",function(){}).on("blur",function(){$dropdownMenu.css("display","");if((opts.indexId===-1&&!opts.idField)||opts.multiWord){return}}).on("click",function(){var word=$(this).val(),words;if($.trim(word)!==""&&word===$(this).attr("alt")&&$dropdownMenu.find("table tr").length){return $dropdownMenu.show()}if($dropdownMenu.css("display")!=="none"){return}if(options.multiWord){words=word.split(options.separator||" ");word=words[words.length-1]}if(word.length===0&&!options.allowNoKeyword){return}getData($.trim(word),$input,refreshDropMenu,options)});$input.parent().find("button:eq(0)").attr("data-toggle","").on("click",function(){var display;if($dropdownMenu.css("display")==="none"){display="block";if(options.url){$input.click().focus()}else{refreshDropMenu($input,options.data,options)}}else{display="none"}$dropdownMenu.css("display",display)
});$dropdownMenu.on("mouseenter",function(){$input.blur();$(this).show()}).on("mouseleave",function(){$input.focus()})});function setBackground($input,opts){var inputbg,bg,warnbg;if((opts.indexId===-1&&!opts.idField)||opts.multiWord){return $input}inputbg=$input.css("background-color").replace(/ /g,"").split(",",3).join(",");bg="rgba(255,255,255,0.1)";warnbg=opts.inputWarnColor||"rgba(255,255,0,0.1)";if(!$input.val()||$input.attr("data-id")){return $input.css("background",bg)}if(-1===warnbg.indexOf(inputbg)){$input.trigger("onUnsetSelectValue");$input.css("background",warnbg)}return $input}function adjustScroll($input,$dropdownMenu){var $hover=$input.parent().find("tbody tr."+options.listHoverCSS),pos,maxHeight;if($hover.length>0){pos=($hover.index()+3)*$hover.height();maxHeight=Number($dropdownMenu.css("max-height").replace("px",""));if(pos>maxHeight||$dropdownMenu.scrollTop()>maxHeight){$dropdownMenu.scrollTop(pos-maxHeight)}else{$dropdownMenu.scrollTop(0)}}}function unHoverAll(ddiv,opts){ddiv=ddiv||$dropdownMenu;opts=opts||options;ddiv.find("tr."+opts.listHoverCSS).removeClass(opts.listHoverCSS)}function checkInput(target){var $input=$(target),$dropdownMenu=$input.parent(".input-group").find("ul.dropdown-menu"),data=$input.data("bsSuggest");if($dropdownMenu.length===0){return false}if(data){return false}$input.data("bsSuggest",{target:target,options:options});return true}function getData(keyword,$input,callback,opts){var data,validData,filterData={value:[]},i,obj,hyphen,URL,len;keyword=keyword||"";opts=opts||options;if(opts.url){hyphen=opts.url.indexOf("?")!==-1?"&":"?";URL=opts.jsonp?[opts.url+keyword,hyphen,opts.jsonp,"=?"].join(""):opts.url+keyword;$.ajax({type:"GET",url:URL,dataType:"json",timeout:3000}).done(function(result){callback($input,result,opts);$input.trigger("onDataRequestSuccess",result);if(options.getDataMethod==="firstByUrl"){options.data=result;options.url=null}}).fail(handleError)}else{data=opts.data;validData=checkData(data);if(validData){if(!keyword){filterData=data}else{len=data.value.length;for(i=0;i<len;i++){for(obj in data.value[i]){if($.trim(data.value[i][obj])&&(inSearchFields(obj,opts)||inEffectiveFields(obj,opts))&&(data.value[i][obj].toString().indexOf(keyword)!==-1||keyword.indexOf(data.value[i][obj])!==-1)){filterData.value.push(data.value[i]);break}}}}}callback($input,filterData,opts)}}function processData(data){return validData=checkData(data)}function checkData(data){var isEmpty=true;for(var o in data){if(o==="value"){isEmpty=false;break}}if(isEmpty){handleError("返回数据格式错误!");return false}if(data.value.length===0){return false}return data}function inEffectiveFields(filed,opts){opts=opts||options;if($.isArray(opts.effectiveFields)&&opts.effectiveFields.length>0&&$.inArray(filed,opts.effectiveFields)===-1){return false}return true}function inSearchFields(filed,opts){if($.inArray(filed,opts.searchFields)!==-1){return true}return false}function refreshDropMenu($input,data,opts){var $dropdownMenu=$input.parent().find("ul.dropdown-menu"),len,i,j,index=0,html=['<table class="table table-condensed">'],thead,tr,idValue,keyValue;opts=opts||options;data=processData(data);if(data===false||(len=data.value.length)===0){$dropdownMenu.empty().hide();return $input}if(opts.showHeader){thead="<thead><tr>";for(j in data.value[0]){if(inEffectiveFields(j)===false){continue}if(index===0){thead+="<th>"+(opts.effectiveFieldsAlias[j]||j)+"("+len+")"+"</th>"}else{thead+="<th>"+(opts.effectiveFieldsAlias[j]||j)+"</th>"}index++}thead+="</tr></thead>";html.push(thead)}html.push("<tbody>");for(i=0;i<len;i++){index=0;tr="";idValue=data.value[i][opts.idField]||"";keyValue=data.value[i][opts.keyField]||"";for(j in data.value[i]){if(!keyValue&&opts.indexKey===index){keyValue=data.value[i][j]}if(!idValue&&opts.indexId===index){idValue=data.value[i][j]}index++;if(inEffectiveFields(j)===false){continue}tr+='<td data-name="'+j+'">'+data.value[i][j]+"</td>"}tr='<tr data-index="'+i+'" data-id="'+idValue+'" data-key="'+keyValue+'">'+tr+"</tr>";html.push(tr)}html.push("</tbody></table>");$dropdownMenu.html(html.join("")).show();listEventBind($input,$dropdownMenu,opts);if($dropdownMenu.css("max-height")&&Number($dropdownMenu.css("max-height").replace("px",""))<Number($dropdownMenu.find("table:eq(0)").css("height").replace("px",""))&&Number($dropdownMenu.css("min-width").replace("px",""))<Number($dropdownMenu.css("width").replace("px",""))){$dropdownMenu.css("padding-right","20px").find("table:eq(0)").css("margin-bottom","20px")}else{$dropdownMenu.css("padding-right",0).find("table:eq(0)").css("margin-bottom",0)}return $input}function listEventBind($input,dropdownMenu,opts){dropdownMenu=dropdownMenu||$dropdownMenu;opts=opts||options;dropdownMenu.find("tbody tr").each(function(e){$(this).off("mouseenter").on("mouseenter",function(e){unHoverAll(dropdownMenu,opts);$(this).addClass(opts.listHoverCSS)}).off("mousedown").on("mousedown",function(e){setValue($input,getPointKeyword($(this)),opts);setBackground($input,opts)})
})}function getPointKeyword(list){var data={};data.id=list.attr("data-id");data.key=list.attr("data-key");return data}function setValue($input,keywords,opts){var _keywords=keywords||{},id=_keywords.id||"",key=_keywords.key||"",inputValList,inputIdList;if(opts&&opts.multiWord){inputValList=$input.val().split(opts.separator||" ");inputValList[inputValList.length-1]=key;$input.val(inputValList.join(opts.separator||" ")).focus()}else{$input.attr("data-id",id).focus().val(key)}$input.trigger("onSetSelectValue",_keywords)}function handleError(e1,e2){if(e2){}}},show:function(){var data=this.data("bsSuggest");if(data&&data.options){this.parent().find("ul.dropdown-menu").show()}return this},hide:function(){var data=this.data("bsSuggest");if(data&&data.options){this.parent().find("ul.dropdown-menu").css("display","")}return this},disable:function(e){if(!$(this).data("bsSuggest")){return false}$(this).attr("disabled",true).parent().find("button").addClass("disabled")},enable:function(){if(!$(this).data("bsSuggest")){return false}$(this).attr("disabled",false).parent().find("button").removeClass("disabled")},destroy:function(){$(this).off().data("bsSuggest","");$(this).parent().find("button").off()}}})(window.jQuery);